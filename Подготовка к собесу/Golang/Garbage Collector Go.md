## Стек:
- Локальные переменные, аргументы функций, адреса возврата и т.д.
- Фиксированный размер
- Не поддерживает динамическое выделение памяти
- Легко и быстро очищается

## Куча:
- Глобальные переменные, ссылочный тип
- Размер ограничен физическими характеристиками ОЗУ
- Динамическое выделение памяти
- Сложность в очистке

## Основные концепции GC:
- Трехцветный алгоритм разметки
- Mark and Sweep алгоритм
- Выполняется параллельно с основной программой

## Трехцветный алгоритм:

Данные в куче рассматриваются как граф связных объектов. Объект может быть помечен белым, серым  и черным цветами. Изначально все объекты помечены как белые.

Операция раскраски объекта эквивалентна его добавлению в соответствующую очередь:
- Обходим корневые объекты и помечаем их серым цветом
- Выбираем серый объект из очереди и сканируем на наличие указателей
- Найденные объекты помечаются серым цветом, а исходный черным
- Повторяем пока очередь серых объектов не пуста
- Белые объекты являются мусором


## Мутатор и  Write barrier:
- Трехцветный алгоритм разметки выполняется параллельно с основной программой, которая называется мутатором. Для поддержания консистентности данных в куче используется write barrier
- Одна из основных задач барьера записи - следить за тем чтобы черные объекты не указывали на белые.
- STW или "Stop the world" - полная остановка программы. Необходима для включения и выключения барьера записи.


## Когда запускать GC?

- Можно вручную с помощью runtime.GC() - однако этот вызов может заблокировать вызывающую функцию или всю программу.
- По умолчанию GC запускается, когда размер кучи становится в 2 раза больше исходного размера. Данный коэффицент можно регулировать изменяя значение переменной среды GOGC.


## Полный цикл работы GC:
- Stop the world
- Ожидание пока все горутины не достигнут safe-point
- Переход к фазе разметки - 25% CPU выделяется:
	-  Включается write barrier
	- Start the world
	- Запускается сканирование глобальных переменных и стеков
	- При сканировании стека работа горутины приостанавливается
	- Выполняется 3-х цветный алгоритм для поиска мусора.
- Переход к фазе завершения разметки:
	- Stop the world
	- Дожидаемся завершения обработки последних задач из очереди
	- Очистка кэшей
	- STW не обязательный
	- Завершаем разметку
- Фаза очистки:
	- Отключается write barrier
	- Start the world
	- Очистка ресурсов в фоне

## Недостатки GC:
- Не реализован алгоритм поколений
- Не реализовано уплотнение
- STW
- Нет возможности тонкой настройки


## Оптимизации:
- Уменьшить кол-во вызовов с помощью изменений переменной GOGC
- Использовать балласт
	- Увеличивает базовый размер кучи
	- Не будет удален как мусор
	- Помечается за O(1)
	- Выделяется в виртуальном пространстве и не использует физическую память
- Использовать sync.Pool