Prometheus был создан в 2012 году и с тех пор стал стандартом для мониторинга систем. Его код полностью открыт и он предоставляет десятки разных экспортеров, с помощью которых за минуты можно настроить мониторинг всей инфраструктуры.


Prometheus - это база данных временных рядов. Но не просто база. К нему можно присоединить целую экосистему инструментов, чтобы расширить изначальный функционал. Prometheus мониторит различны системы - серверы, базы данных, отдельные виртуальные машины.
Позволяет ему это делать периодический скрейпинг целевых объектов.


## Скрейпинг
Prometheus извлекает метрики через HTTP-вызовы к определенным конечным точкам, указанным в конфигурации Prometheus.
![[Pasted image 20231029172318.png]]
На примере веб-приложения:
- Приложение расположено по адресу http://localhost:3000. Приложение передает метрики в текстовом формате на некий URL, допустим - http://localhost:3000/metrics. По этому адресу Prometheus  с определенными интервалами извлекает данные из целевого объекта.


### Как работает Prometheus:
Способы извлечения метрик:
- Инструментирование приложения, то есть ваше приложение будет предоставлять совместимые с Prometheus метрики по заданному URL. Prometheus определит его как целевой объект и будет скрейпить с указанным интервалом.
- Использование готовых экспортеров. В Prometheus есть целая коллекция экспортеров для существующих технологий. Например, для мониторинга Linux машин (Node exporter), для распространенных баз данных (SQL Exporter), балансировщика нагрузки (HAProxy Exporter)
- Использование Pushgateway. Иногда приложения или задания не предоставляют метрики напрямую. Они могут быть не преднозначены для этого (пакетные задания) или вы сами не решили предоставлять метрики напрямую через приложение.

![[Pasted image 20231029172845.png]]


### Сбор VS отправка
У Prometheus есть отличие от других баз данных временных рядов - он активно сканирует целевые объекты, чтобы получить у них метрики.
Причины сбора метрик самостоятельно:
- Централизованный контроль -  Если Prometheus отправляет запросы целевым объектам, всю настройку мы выполняем на стороне Prometheus, а не на отдельных системах.
- Prometheus хранит агрегированные метрики - Prometheus не основан на событиях и этим сильно отличается от других баз данных временных рядов - он перехватывает отдельные события с привязкой ко времени, а собирает предварительно агрегированные метрики о ваших сервисах.


### Экосистема Prometheus
Prometheus поддерживает следующие инструменты, расширяющие его функционал:
- Alertmanager - Prometheus отправляет оповещения в AlertManager на основе кастомных правил, определенных в файлах конфигурации. Оттуда можно экспортировать в конечные точки - Slack
- Визуализация данных - как и в Grafana - можно визуализировать временные ряды прямо в пользовательском интерфейсе Prometheus - можно фильтровать данные и составлять конкретные обзоры происходящего в целевых объектах.
- Обнаружение сервисов - Prometheus динамически обнаруживает целевые объекты и автоматически скрейпит новые цели по запросу. Это удобно, если вы работаете с контейнерами, которые динамически меняют адреса в зависимости от спроса.
![[Pasted image 20231029173502.png]]


### Концепции Prometheus
1. Модель данных ключ-значение. Ключ описывает то, что мы измеряем, а значение хранит фактическую величину в виде числа. Ярлыки служат для того, чтобы кастомизировать запрос.![[Pasted image 20231029173809.png]]
2. Типы метрик
	1. Счетчик - самый простой тип метрик, считывающий элементы за период времени. Определяет количество HTTP ошибок, посещений сайта. Поддерживает только инкрементацию и обнуление.
	2. Измерители - идеально подходят для измерения текущего значения метрики, которое со временем может уменьшиться. Измеритель показывает среднее значение дельты счетчика для единицы за период времени. Если система отправляет метрики каждые 5 секунд, а Prometheus скрейпит целевой объект каждые 15, в процессе можно потерять некоторые метрики.
	3. Гистограмма - предоставляет дополнительную информацию, например - сумма измерений и их количество. Гистограмма может
		1. Рассчитывать средние значения - сумму значений, поделенную на количество значений
		2. Рассчитывать относительные измерения значений - удобно, если нужно узнать сколько значений в определенной области соответствует заданным критериям. Особенно полезно, если нужно отслеживать пропорции или установить индикаторы качества
	4. Сводки - это расширенные гистограммы. Так же показывают сумму и количество измерений, а еще квантили за скользящий период. Квантили - это деление плотности вероятности на отрезки равной вероятности.
### Гистограммы vs Сводки
Гистограммы объединяют значения за период времени, предоставляя сумму и количество по которым можно отследить развитие определенной метрики.
Сводки показывают квантили за скользящий период - непрерывное развитие во времени.


### Задания и экземпляры
На языке Prometheus экземпляром называется один веб-сервер. Заданием будет тот факт, что вы измеряете число ошибок HTTP на всех экземплярах.
![[Pasted image 20231029174928.png]]

### PromQL
У Prometheus есть свой язык для запросов и извлечения данных с серверов - PromQL.
PromQL возвращает результаты в виде векторов.

Векторы в Prometheus:
- Моментальные векторы - представляют метрики по последней метке времени
- Векторы с диапазоном времени - представляют метрики, включающие значения из всего периода.![[Pasted image 20231029175247.png]]
Метрики можно сортировать по значению, применять математические функции и строить прогнозы на их основе.


### Инструментирование
-это важная часть Prometheus. Перед тем, как извлекать данные из приложения, нужно его инструментировать.

На языке Prometheus инструментирование - это добавление клиентских библиотек, чтобы они предоставляли метрики Prometheus.

С инструментированием создаются объекты памяти - измерители, счетчики и т.д., которые будут динамически увеличивать или уменьшать значения. Затем выбирается, куда приложение будет отсылать метрики и Prometheus их оттуда заберет и сохранит в свою БД

### Экспортеры
В написанных вами приложениях удобно настраивать предоставляемые метрики и их изменение со временем с помощью инструментирования.

Для известных приложений, серверов и баз данных Prometheus предлагает экспортеры, с помощью которых можно мониторить целевые объекты. Эти экспортеры обычно представлены в виде Docker образов и легко настраиваются. Они предоставляют набор метрик, готовые панели мониторинга с которыми можно настроить мониторинг за секунды.


Примеры экспортеров:
- Экспортер БД - для баз MongoDB, серверов SQL и MySQL.
- Экспортер HTTP: для сереверов HAProxy, Apache и NGINX
- Экспортеры Unix: производительность системы можно отслеживать с помощью встроенных экспортеров узлов, которые предоставляют все системные метрики без доп настройки.
![[Pasted image 20231029175853.png]]

### Менеджер оповещений
-это отдельный инструмент, который присоединяется к Prometheus и запускает кастомные оповещатели. Оповещеия определяеются в файле конфигурации и задают набор правил для метрик. Если во временных рядах возникает соответствие правилу, оповещение инициируется и отправляется заданным получаетелем.
В качестве получателя можно указать Webhook Slack, PagerDuty и кастомные HTTP-объекты.

